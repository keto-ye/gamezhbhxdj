<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>test</title>

<!-- 数据及操作函数 -->
<script>       
    num_event = 10;  // 事件数
    const event_names = {
        1: "你们不要再打了",
        2: "你们关系很好吗",
        3: "物资调动",
        4: "门派冲突",
        // 5: "举办宴会",
        5: "弹劾",  // TODO
        6: "华彩宝灯",
        7: "挑事",
        8: "我要做课业",
        9: "借地炼丹",
        10: "又见面了",
    };
    const event_description = {
        1: "难怪最近没看见两位道尊——李伏和封铮在东岳的山巅打得不可开交，都不知打了多少天了。<br>如果没人能帮李伏劝住封铮，他们还会继续“切磋”下去。",
        2: "封铮的态度充满敌意。<br>总之，郦自衡今天必须得解释清楚，为什么玲总是帮他。",
        3: "“物资调动”是个正经名头，但郦掌门调来调去，最后总会有些东西不见踪影。冯长老受够了这种贪污的恶行。<br>郦自衡在此事件中胜利时，他的筹备进度增加。",
        4: "冲突是两岳的常态。今天，又有两拨人正在对峙，为了利益或者恩怨。<br>赢家的势力值会增加，赢家的同盟亦然。",
        // 5: "或许是因为发生了好事、为了联络感情，或者只是因为太闲，有人提议举办宴会。",
        5: "冯长老终于掌握了郦自衡贪污的证据。他向掌门发起弹劾。<br>郦自衡在此事件中失败时，他的筹备进度减少。",
        6: "华彩宝灯——由归藏门炼制、被前后两任掌门许诺送给陆英华，却又被齐瀚抢走的，修道界第一等的奇珍异宝，如今到底该归谁？每次陆英华有不顺心，就要把此事摆上台面争一争。",
        7: "秦直渴望有一块自己的地盘，而非呆在李伏手底下。所以，他有时会来西岳挑点事，寻找机遇。<br>（他最喜欢古柯宗，偶尔也去别的地方试试。）",
        8: "白澈是个很乖、很老实的后辈；所以总有人想使唤他干活，或带他出去玩。但是今天真的不行！因为他的课业要做不完了。",
        9: "姜月茗会在任何地方炼丹——任何地方。然后，此地会烟熏火燎，灵力干涸；所以大家都衷心期望她别来。",
        10: "人们有时候会在陆家的禁地里发现秦直，后者通常在睡觉、弹琴、或者尝试边睡觉边弹琴。没人知道他是什么时候溜进去的。<br>虽然秦直没有恶意，但陆家修士还是得请他出去。",

    };
    event_charac_side1 = {  // 事件的势力方1的角色 注意如果有一个0，应在side2而非1
        1: 4, 2: 3, 3: 2, 4: 0, 5: 13, 6: 8, 7: 10, 8: 11, 9: 9, 10: 10
    };
    event_charac_side2 = {  // 事件的势力方2的角色
        1: 3, 2: 2, 3: 13, 4: 0, 5: 2, 6: 6, 7: 0, 8: 0, 9: 0, 10: 0
    };
    num_charac = 19;
    const characters = {
        0: "",
        1: "玲",
        2: "郦自衡",
        3: "封铮",
        4: "李伏",
        5: "白圭",
        6: "齐瀚",
        7: "澹台涛",
        8: "陆英华",
        9: "姜月茗",
        10: "秦直",
        11: "白澈",
        12: "陆绮",
        13: "冯长老",
        14: "袁尚",
        15: "白露",
        16: "余敏亭",
        17: "周纪",
        18: "孟蝶",
        19: "陆守非",

    };
    const charac_descrip = {
        0: "",
        1: "说客：行动点+1",
        2: "凌虚阁掌门：事关凌虚阁时，影响力+2<br>美姿容：游说秦直、陆绮时，有0.5概率不消耗行动点",
        3: "情种：被玲招募时，不消耗行动点<br>武痴：被玲之外的人招募时，有0.8的概率失败",
        4: "东岳领导者：事关东岳时，影响力+2<br>大忙人：被招募时，有0.5的概率失败；白澈不受该特性影响",
        5: "归藏门掌门：事关归藏门时，影响力+2<br>挚友：招募陆英华时不消耗行动点<br>慈父：被白澈招募时，不消耗对方的行动点",
        6: "无尽踪：敌方所有境界不高于自己的法修的影响力-1<br>古柯宗掌门：事关古柯宗时，影响力+2<br>多疑：被招募时有0.5概率失败",
        7: "淮山掌门方丈：事关淮山时，影响力+2<br>空性：对抗中，敌方所有境界不高于自己的武修的影响力-1<br>不想干活：被招募时有0.5的概率失败",
        8: "化神第一：影响力+2<br>陆家家主：在东岳的事务中，影响力+2<br>挚友：招募白圭时不消耗行动点<br>母亲：被陆绮游说时，有0.5概率不消耗对方的行动点",
        9: "丹修：行动点+2；影响力-2",
        10: "师侄：被齐瀚游说时，有0.5概率不消耗对方的行动点<br>强控：敌方所有境界不高于自己的角色影响力-1<br>墙头草：被招募后，可以被敌对阵营继续游说，招募成功率0.5",
        11: "乖孩子：被李伏、白圭招募时，不消耗对方的行动点",
        12: "女儿：被陆英华招募时，有0.5概率不消耗对方的行动点<br>骄纵：被境界不高于自己的角色招募时，有0.5概率失败",
        13: "凌虚阁长老：事关凌虚阁时，影响力+1",
        14: "古柯宗骨干：事关古柯宗时，影响力+1<br>旧怨：不能游说归藏门势力的角色",
        15: "红人：游说归藏门的角色时，有0.5概率不消耗行动点",
        16: "过劳：行动点-1<br>归藏门管事：在归藏门的事务中，影响力+1",
        17: "情报贩子：敌方随机一名角色影响力-2",
        18: "僧值：事关淮山时，驱逐敌方随机一名元婴及以下角色",
        19: "陆家主事：事关东岳时，自身说服力+1",

    }; 
    const sides = {  // 所有势力
        0: "无",
        1: "凌虚阁",
        2: "古柯宗",
        3: "归藏门",
        4: "淮山",
        5: "东岳",
    };
    side_character = {  // 门派包含的角色
        1: [2,13],
        2: [6,14,17],
        3: [5,15,16],
        4: [7,18],
        5: [4,8,9,10,11,12,19],
    }
    charac_side = {  // 角色的势力归属
        0: 0, 1: 0, 2: 1, 3: 0, 4: 5, 5: 3, 6: 2, 7: 4, 8: 5, 9: 5, 10: 5, 
        11: 5, 12: 5, 13: 1, 14: 2, 15: 3, 16: 3, 17: 2, 18:4, 19:5
    }
    event_charac_side2_may = {  // 可能的势力方2的角色
        8: side_character[3].concat(side_character[5]).filter(item => item !== 11),
        9: Array.from({ length: num_charac - 4 }, (val, i) => i + 5),
        10: [8, 12, 19]
    };
    // 不消耗次数+必成功的游说组合 游: 被游
    nominus_suc = {
        1: [3],
        4: [11],
        5: [8, 11],
        11: [5]
    };
    // 0.5消耗次数+必成功 游: 被游
    mayminus_suc = {
        2: [10,12],
        6: [10],
        15: [5,16],
        12: [8],
        8: [12],
        15: [5,16]
    };
    // 影响力系数
    coef = [10, 5, 1, 0.2];
    // 各影响力系数对应的角色
    charac_coef = [[3, 4], [5, 6, 7, 8, 9, 10], [2, 12, 13, 13, 14, 15, 16, 17, 19], [1, 11, 18]];
    // 角色对其他角色的影响 
    byqi = [1,2,5,10,15,16]  // 被齐瀚-1
    bydan = [6,8,12,13,14]  // 被澹台涛-1
    byqin = [1,2,5,6,7,8,9,11,12,13,14,15,16]  // 被秦-1
    // 角色对己影响
    effect_self_all = { //全局
        8:2,
        9:-2
    }
    effect_self_place = { //地点 '角色-势力':点数
        '2-1':2,
        '6-2':2,
        '5-3':2,
        '8-5':2,
        '7-4':2,
        '13-1':1,
        '14-2':2,
        '16-3':1,
        '4-5':2
    }
    fighting = true  // 封李是否在打架
    gifts = {  // 封铮出场时能触发的随机弹窗+进展 TODO
        1: "",
    }

    // 更新己方角色
    function update_our(){
        tdstyle = "height:150px;width:100px;text-align:center;vertical-align:top;border-right:#000000 solid 1px;border-left:#000000 solid 1px;border-top:#000000 solid 1px;border-bottom:#000000 solid 1px;"
        tdstylenone = "height:150px;width:100px;text-align:center;vertical-align:top;visibility:hidden;"
        idname = "cgo"
        for(var n=0;n<charac_our.length;n++)
        {
            if (charac_our[n] != 0)
            {
                cg = document.getElementById(idname + (n+1).toString());
                cg.innerHTML = characters[charac_our[n]]
                descElem = document.getElementById(idname + (n+1).toString() + "_desc");
                descElem.innerHTML = charac_descrip[charac_our[n]];
                descElem.parentNode.style = tdstyle;
                cg = document.getElementById("td" + idname + (n+1).toString());
                cg.style = tdstyle;
            }
            else
            {
                cg = document.getElementById("td" + idname + (n+1).toString());
                cg.style = tdstylenone;
                document.getElementById(idname + (n+1).toString() + "_desc").innerHTML = "";
            }
        }
    }
    // 更新敌方角色
    function update_enemy(){
        tdstyle = "height:100px;width:100px;text-align:center;vertical-align:top;border-right:#000000 solid 1px;border-left:#000000 solid 1px;border-top:#000000 solid 1px;border-bottom:#000000 solid 1px;"
        tdstylenone = "height:100px;width:100px;text-align:center;vertical-align:top;visibility:hidden;"
        idname = "enemy"
        for(var n=0;n<charac_enemy.length;n++)
        {
            if (charac_enemy[n] != 0)
            {
                cg = document.getElementById(idname + (n+1).toString());
                cg.innerHTML = characters[charac_enemy[n]];
                descElem = document.getElementById("enemy" + (n+1).toString() + "_desc");
                descElem.innerHTML = charac_descrip[charac_enemy[n]];
                cg = document.getElementById("td" + idname + (n+1).toString());
                cg.style = tdstyle;
            }
            else
            {
                cg = document.getElementById("td" + idname + (n+1).toString());
                cg.style = tdstylenone;
                document.getElementById("enemy" + (n+1).toString() + "_desc").innerHTML = "";
            }
        }
    }
    // 更新可招募角色
    function update_totalk(){
        idname = "ctotalk"
        tdstyle = "height:150px;width:100px;text-align:center;vertical-align:top;border-right:#000000 solid 1px;border-left:#000000 solid 1px;border-top:#000000 solid 1px;border-bottom:#000000 solid 1px;"
        tdstylenone = "height:150px;width:100px;visibility:hidden;"
        for(var n=0;n<charac_totalk.length;n++)
        {
            ct = document.getElementById(idname + (n+1).toString());
            ct.innerHTML = characters[charac_totalk[n]];
            ct = document.getElementById("td" + idname + (n+1).toString());
            if (charac_totalk[n] != 0)
            {
                ct.style = tdstyle;
                descElem = document.getElementById("ctotalk" + (n+1).toString() + "_desc");
                descElem.innerHTML = charac_descrip[charac_totalk[n]];
            }
            else
            {
                ct.style = tdstylenone;
                document.getElementById("ctotalk" + (n+1).toString() + "_desc").innerHTML = "";
            } 
        } 
    }
    // 更新行动点
    function update_cango(){
        idname = "cango"
        for(var n=0;n<charac_our.length;n++)
        {
            if (charac_our[n] == 0)
            {break;}
            cg = document.getElementById(idname + (n+1).toString());
            cg.innerHTML = "剩余行动点: " + charac_action[charac_our[n]].toString()
            // 禁用/启用勾选框
            cb = document.getElementById("charac_go" + (n + 1).toString());
            cb.disabled = (charac_action[charac_our[n]] <= 0);
        }
    }
    // 输出事件进展
    function update_output(new_out){
        eventoutput = document.getElementById("eventoutput");
        // 创建带样式的span
        let styled_out = new_out;
        if (new_out.includes("（敌方）")) {
            styled_out = '<span style="color: #8B0000; font-family: 宋体;">' + new_out + '</span>';
        } else if (new_out.includes("（己方）")) {
            styled_out = '<span style="color: #2A4F6E; font-family: 宋体;">' + new_out + '</span>';
        }
        eventoutput.innerHTML += styled_out + "<br>";
        scrollin = document.getElementById("scrollin");
        scrollin.scrollTop = scrollin.scrollHeight;  // 自动滚动到最下方
    }

    // 初始化一局
    function begin_game(){
        new_event();
        // 势力值随机10~80
        menpais = document.querySelectorAll('#menpai1, #menpai2, #menpai3, #menpai4, #menpai5')
        menpais.forEach(function(s) {
            s.value = Math.floor(Math.random()*70) + 10
        })
        car = document.getElementById("carry");  
        car.value = 0;
        // 事件进展清空
        eventoutput = document.getElementById("eventoutput");
        eventoutput.innerHTML = ""
        // 调查和转移进度=0
        inv = document.getElementById("invest");  
        inv.value = 0;
        car = document.getElementById("carry");  
        car.value = 0;
    }
    // 随机角色
    function random_c(sc)
    {
        if_high = (Math.random() > 0.9)  // 招来高阶的概率系数
        cc = side_character[sc][Math.floor(Math.random()*side_character[sc].length)];
        if (!if_high)
        {
            while(cc!=2 && cc<11)
            {cc = side_character[sc][Math.floor(Math.random()*side_character[sc].length)];}
        }
        return cc
    }
    // 事件4 门派冲突
    function event4()
    {
        // 门派
        s1 = Math.floor(Math.random()*5) + 1;
        s2 = s1*1
        while (s2 == s1){
            s2 = Math.floor(Math.random()*5) + 1;
        }
        // 角色
        c1 = random_c(s1)
        c2 = random_c(s2)
        return  [c1, '（' + sides[s1] + '）', c2, '（' + sides[s2] + '）']
    }
    // 事件8,9,10 从字典随机人物
    function event_cfromdict()
    {
        to_be = event_charac_side2_may[event_now]
        cc = to_be[Math.floor(Math.random()*to_be.length)]
        ss = charac_side[cc]
        return [cc, '（' + sides[ss] + '）']
    }
    // 生成新事件
    function new_event(){
        // 事件序号 TODO next
        available_event = Array.from({ length: num_event }, (val, i) => i+1);
        if (!fighting)
        {available_event = available_event.filter(item => item !== 1);}

        // 事件信息
        event_now = Math.floor(Math.random()*num_event) + 1
        eve_name = document.getElementById("eve_name")
        eve_name.innerHTML = event_names[event_now]
        eve_desc = document.getElementById("eve_desc")
        side1charc = document.getElementById("side1charc")
        side1 = document.getElementById("side1")
        side2charc = document.getElementById("side2charc")
        side2 = document.getElementById("side2")
        eve_desc.innerHTML = event_description[event_now]
        switch (event_now) {
            case 4:
                [event_charac_side1[event_now], side1.innerHTML, 
                    event_charac_side2[event_now], side2.innerHTML] = event4();
                break;
            case 8:
            case 9:
            case 10:
                side1.innerHTML = '（' + sides[charac_side[event_charac_side1[event_now]]] + '）';
                [event_charac_side2[event_now], side2.innerHTML] = event_cfromdict();
                break;
            default:
                side1.innerHTML = '（' + sides[charac_side[event_charac_side1[event_now]]] + '）'
                side2.innerHTML = '（' + sides[charac_side[event_charac_side2[event_now]]] + '）'
        }
        side1charc.innerHTML = characters[event_charac_side1[event_now]]
        side2charc.innerHTML = characters[event_charac_side2[event_now]]
        hide_info()
        // 生成可招募角色
        charac_totalk = [0, 0, 0, 0, 0];
        notallowed = [1, 2, event_charac_side1[event_now], event_charac_side2[event_now]]
        if (fighting == true)  // 封李打架
        {
            notallowed.push(3,4)
        }
        for (var i=0;i<5;i++)
        {
            var n = Math.floor(Math.random()*num_charac) + 1;
            // 选事件不涉及，非玲和郦自衡，不重复的角色
            if (!notallowed.includes(n) && !charac_totalk.includes(n))
            {
                charac_totalk[i] = n;
            }
            else
            {
                i--;
            }
        }  
        update_totalk()
        // 己方角色
        charac_our = [1, 0, 0, 0, 0, 0, 0]
        update_our()
        // 敌方角色
        charac_enemy = [0, 0, 0, 0, 0, 0, 0]
        update_enemy()
        // 所有角色行动点
        charac_action = Array.from({ length: num_charac+1 }, (val, i) => 1)
        charac_action[1] += 1
        charac_action[9] += 2
        charac_action[16] = 0
        update_cango()
        // 显示join按钮
        b_jside1 = document.getElementById("joinside1").style.display = 'inline';
        b_jside2 = document.getElementById("joinside2").style.display = 'inline';
        // 影响力
        document.getElementById("ene_efftxt").innerHTML = ""
        document.getElementById("our_efftxt").innerHTML = ""
    }

    // 隐藏表格等信息
    function hide_info(){
        ene_chatxt = document.getElementById("ene_chatxt")
        ene_chatxt.innerHTML = ""
        ene_table = document.getElementById("ene_table").style.display = 'none'
        totalktxt = document.getElementById("totalktxt")
        totalktxt.innerHTML = ""
        totalk_table = document.getElementById("totalk_table").style.display = 'none'
        our_chatxt = document.getElementById("our_chatxt")
        our_chatxt.innerHTML = ""
        our_table = document.getElementById("our_table").style.display = 'none'
        talk = document.getElementById("talk").style.display = 'none'
        // 换行
        brs = document.querySelectorAll('#br1, #br2, #br3')
        brs.forEach(function(br) {
            br.innerHTML = ""
        })
    }
    // 显示游说等信息
    function show_info(){
        cal_effect()  // 影响力
        ene_chatxt = document.getElementById("ene_chatxt")
        ene_chatxt.innerHTML = "敌方角色：<br>"
        ene_table = document.getElementById("ene_table").style.display = 'table'
        totalktxt = document.getElementById("totalktxt")
        totalktxt.innerHTML = "当前可招募的角色：<br>"
        totalk_table = document.getElementById("totalk_table").style.display = 'table'
        our_chatxt = document.getElementById("our_chatxt")
        our_chatxt.innerHTML = "己方角色：<br>"
        our_table = document.getElementById("our_table").style.display = 'table'
        talk = document.getElementById("talk").style.display = 'table'
        // 换行
        brs = document.querySelectorAll('#br1, #br2, #br3')
        brs.forEach(function(br) {
            br.innerHTML = "<br>"
        })
    }
    // 隐藏加入按钮
    function update_join(){
        b_jside1 = document.getElementById("joinside1").style.display = 'none';
        b_jside2 = document.getElementById("joinside2").style.display = 'none';
        if (event_now == 1)
        {
            if (charac_enemy[0] == 3)  // 郦自衡会阻碍封铮出场
            {
                charac_enemy[1] = 2;
                new_output = "郦自衡不会让玲轻而易举地获得一个好帮手。";
                update_output(new_output)
            }
        }
        show_info()
        update_our()
        update_enemy()
        update_cango()
    }
    // 选择加入势力后
    function join_side1(){
        charac_our[1] = event_charac_side1[event_now]
        charac_enemy[0] = event_charac_side2[event_now]
        update_join()
    }
    function join_side2(){
        charac_our[1] = event_charac_side2[event_now]
        charac_enemy[0] = event_charac_side1[event_now]
        update_join()
    }

    // 敌人的招募
    // 1 招募同势力角色，概率随机境界
    // 2 招募友方势力角色，概率随机境界
    // 3 郦自衡按特定顺序招募可招募角色 + 他的友方角色
    // 4 郦自衡先手，其余按序列检查行动点
    li_friends = [10, 12, 14, 17]  // 郦的友方角色
    li_priority = [8, 6, 5, 7, 9, 10, 4]  // 招募陆齐>其他化神>李伏>元婴
    function add_enemy(){
        if (charac_enemy[0] == 3 && charac_enemy[1] == 0)  // 只有封铮，不add
        {return}
        to_add = []  // 可能招募到的角色
        add_c = 0  // 被招募的角色
        if (charac_enemy.includes(2) && charac_action[2] > 0)
        {
            to_add = li_friends.concat(charac_totalk)
            to_add = to_add.filter(item => (item != 3 && charac_enemy.includes(item) 
                == false && item != 0));
            to_add = to_add.filter(item => (charac_our.includes(item) == false
                || item == 10));
            if (event_now > 3){to_add.push(13);}  // 可以招到冯长老
            if (charac_our.includes(10)){to_add.push(10);}  // 可以招到秦直
            // 按顺序招
            for (var i=0;i<li_priority.length;i++)
            {
                if (to_add.includes(li_priority[i]) != 0)
                {
                    add_c = li_priority[i];
                    break;
                }
            }  
            if (add_c == 0)  // 随机招募
            {add_c = to_add[Math.floor(Math.random()*to_add.length)];}
            charac_action[2] -= 1
        }
        else
        {
            if_high = (Math.random() > 0.8)  // 招来高阶的概率系数
            for (var i=0;i<charac_enemy.length;i++)
            {
                // TODO check
                if (charac_enemy[i] != 0 && charac_action[charac_enemy[i]] > 0)  // 这个人招募
                {
                    to_add = side_character[charac_side[charac_enemy[i]]];
                    to_add = to_add.filter(item => (charac_our.includes(item) == false
                        || item == 10));
                    to_add = to_add.filter(item => (item != 3 && charac_enemy.includes(item) 
                        == false && item != 0));
                    if (charac_enemy[i] < 11 && charac_enemy[i] > 2)
                    {if_high = true;}  // 高阶叫高阶不受概率限制
                    if (if_high == false)
                    {to_add = to_add.filter(item => (item == 2 || item >= 11));}
                    if (to_add.length>=1)
                    {
                        add_c = to_add[Math.floor(Math.random()*to_add.length)];
                        charac_action[charac_enemy[i]] -= 1
                        break;
                    }                    
                }
            }  
        }
        // 修改角色位置
        if (add_c != 0)
        {
            charac_enemy[charac_enemy.indexOf(0)] = add_c;
            if (charac_our.includes(add_c))
            {
                charac_our[charac_our.indexOf(add_c)] = 0;
                new_output = "（敌方）敌人抢走友方"
            }
            else if (charac_totalk.includes(add_c))
            {
                charac_totalk[charac_totalk.indexOf(add_c)] = 0;
                new_output = "（敌方）敌人游说"
            }
            else
            {new_output = "（敌方）敌人带来新同盟"}
        }
        else
        {new_output = "（敌方）无行动"}
        update_output(new_output)
    }
    // 获取游说信息
    function talk_info(){
        try {
        } catch (error) {
            console.error('错误发生在:', error);
            alert('发生错误: ' + error.message);
        }
        new_enemy = add_enemy()  // 敌人的招募
        // 被游说的角色
        c_to = 0
        idname = "charac_to"
        for(var n=0;n<charac_totalk.length;n++)
        {
            ct = document.getElementById(idname + (n+1).toString());
            if (ct.checked)
            {
                ct.checked = false
                c_to = charac_totalk[n];
                break;
                where_to = n+0;
            }
        }
        // 去游说的角色
        c_go = 0
        idname = "charac_go"
        for(var n=0;n<charac_our.length;n++)
        {
            cg = document.getElementById(idname + (n+1).toString());
            if (cg.checked)
            {
                cg.checked = false 
                c_go = charac_our[n];
                break;
            }
        }
        // 是否成功
        suc = false
        if (nominus_suc.hasOwnProperty(c_go) && nominus_suc[c_go].includes(c_to))
        {
            // 不消耗次数+必成功的游说组合 
            suc=true;
        }
        else if (mayminus_suc.hasOwnProperty(c_go) && mayminus_suc[c_go].includes(c_to))
        {
            // 0.5消耗次数+必成功
            suc=true;
            if (Math.random() > 0.5)
            {
                charac_action[c_go] -= 1  // 行动次数-1  
            }
        }
        else if(c_to==6 || c_to==7  || ((c_go==1 || c_go==11) && c_to==12)
            || (c_to==4 && c_go!=11))
        {
            // 消耗次数且0.5概率失败，即齐瀚、澹台涛被游，陆绮被金丹，李伏被白澈以外
            charac_action[c_go] -= 1  // 行动次数-1  
            if (Math.random() > 0.5)
            {
                suc=true;
            }
            else
            {
                suc=false;
            }
        }
        else if(c_to==3 &&c_go!=1)
        {
            // 消耗次数且0.8概率失败，即封铮被玲以外（好耶！
            charac_action[c_go] -= 1;
            if (Math.random() > 0.8)
            {
                suc=true;
            }
            else
            {
                suc=false;
            }
        }
        else if (c_go==14 && charac_side[c_to]==3)  // 袁尚游说归藏门
        {
            suc=false;
        }
        else if(c_go==0 || c_to==0)
        {
            // 没选
            suc=false //TODO
        }
        else
        {
            // 其他，消耗次数+成功
            suc=true;
            charac_action[c_go] -= 1;  
            // TODO 竞争游说的分支
        }
        // 输出和转移角色
        if (suc)
        {
            new_output = '（己方）游说成功'  // TODO 不同的结果文本
            for (var i=0;i<7;i++)
            {
                if (charac_our[i] == 0)
                {
                    charac_our[i] = c_to
                    break
                }
            }  
            for (var i=0;i<5;i++)
            {
                if (charac_totalk[i] == c_to)
                {
                    charac_totalk[i] = 0
                    break
                }
            }  
        }
        else
        {
            new_output = '（己方）游说失败'  // TODO 不同的结果文本
        }
        // 实时更新影响力
        cal_effect()
        // 更新相关
        update_output(new_output)
        update_cango()
        update_totalk()
        update_our()
        update_enemy()
    }

    function after_by(charac_oppo, charac_be){ // 影响 被影响
        // 计算角色当前影响力
        // 被影响
        effect_be = {}
        for (var i=0;i<charac_be.length;i++)
        {
            effect_be[charac_be[i]] = 5;
        }
        if (charac_oppo.includes(6)){  // 被齐瀚-1
            for (var i=0;i<byqi.length;i++)
            {
                if (effect_be.hasOwnProperty(byqi[i]))
                {
                    effect_be[charac_be[i]] -= 1;
                }
            }
            
        }
        if (charac_oppo.includes(7)){  // 被澹台涛-1
            for (var i=0;i<bydan.length;i++)
            {
                if (effect_be.hasOwnProperty(bydan[i]))
                {
                    effect_be[charac_be[i]] -= 1;
                }
            }
            
        }
        if (charac_oppo.includes(7)){  // 被秦-1
            for (var i=0;i<byqin.length;i++)
            {
                if (effect_be.hasOwnProperty(byqin[i]))
                {
                    effect_be[charac_be[i]] -= 1;
                }
            }
            
        }
        if (charac_oppo.includes(17)){  // 被周纪-1
            tobe = charac_be.filter(item => item !=0);
            be = Math.floor(Math.random()*tobe.length);
            effect_be[tobe[be]] -= 1;
        }
        // 自身影响
        for (var i=0;i<charac_be.length;i++)
        {
            // 全局
            if (effect_self_all.hasOwnProperty(charac_be[i]))
            {
                effect_be[charac_be[i]] += effect_self_all[charac_be[i]];
            }
            // 取决于地点 双方势力符合其一即可
            k1 = charac_be[i].toString() + '-' + charac_side[event_charac_side1[event_now]].toString()
            k2 = charac_be[i].toString() + '-' + charac_side[event_charac_side2[event_now]].toString()
            if (effect_self_place.hasOwnProperty(k1))
            {
                effect_be[charac_be[i]] += effect_self_place[k1];
            }
            else if (effect_self_place.hasOwnProperty(k2))
            {
                effect_be[charac_be[i]] += effect_self_place[k2];
            }
        }
        if (charac_oppo.includes(18)){  // 被孟蝶=0  此项须在最后
            tobe = charac_be.filter(item => (item == 2 || item >= 11));
            be = Math.floor(Math.random()*tobe.length);
            effect_be[tobe[be]] = 0;
        }
        return effect_be
    }
    // 计算和刷新影响力
    function cal_effect()  //TODO 未干涉
    {
        // 角色去掉0
        ce = charac_enemy.filter(item => item != 0);
        co = charac_our.filter(item => item != 0);
        effect_charac = Object.assign(after_by(ce, co),
            after_by(co, ce))
        // alert(Object.keys(effect_charac))
        // alert(Object.values(effect_charac))
        // 加权求和
        effect_e = 0
        effect_o = 0
        for (var i=0;i<coef.length;i++)
        {
            for(var j=0;j<co.length;j++)
            {
                if(charac_coef[i].includes(co[j]))
                {effect_o += coef[i]*effect_charac[co[j]]}
            }
            for(var j=0;j<ce.length;j++)
            {
                if(charac_coef[i].includes(ce[j]))
                {effect_e += coef[i]*effect_charac[ce[j]]}
            }
        }
        // update info
        ene_efftxt = document.getElementById("ene_efftxt")
        ene_efftxt.innerHTML = "敌方影响力：" + effect_e.toString() + "<br>"
        our_efftxt = document.getElementById("our_efftxt")
        our_efftxt.innerHTML = "己方影响力：" + effect_o.toString() + "<br>"
    }
    // 势力值变化
    function menpai_change(charac_win, charac_lose){
        // 胜方 非高阶每人+4~6 高阶每人+15~24
        // 败方 - (sum(win) - 5~10) 高阶承担5，剩余均分
        // 玲无影响
        all_affect = {}
        need_minus = 0.0
        for(var i=0;i<charac_win.length;i++)
        {
            if(charac_win[i] > 2 && charac_win[i] < 11)
            {   
                // 胜方高阶
                n = Math.floor(Math.random()*10) + 15;
                all_affect[charac_win[i]] = n;
                need_minus += n
            }
            else if (charac_win[i] == 2 || charac_win[i] >= 11)
            {   
                // 胜方非高阶
                n = Math.floor(Math.random()*3) + 4;
                all_affect[charac_win[i]] = n;
                need_minus += n
            }
        }
        charac_lose_low = charac_lose.filter(item => ((item == 2 || item >= 11)))
        for(var i=0;i<charac_lose.length;i++)
        {
            if(charac_lose[i] > 2 && charac_lose[i] < 11)
            {
                // 败方高阶
                all_affect[charac_lose[i]] = -5;
                need_minus -= 5
            }
            else if (charac_lose[i] == 2 || charac_lose[i] >= 11)
            {
                // 败方非高阶
                all_affect[charac_lose[i]] = -need_minus/(charac_lose_low.length);
            }
        }
        // 进度条
        idname = "menpai"
        for(var n=1;n<5;n++)
        {
            for(var i=0;i<side_character[n].length;i++)
            {
                if(all_affect.hasOwnProperty(side_character[n][i]))
                {
                    mp = document.getElementById(idname + n.toString());
                    mp.value += all_affect[side_character[n][i]];
                }
            }
        }
    }
    // 判断游戏胜负
    function winorfail(){
        mp_limit = 100
        end = true
        if (document.getElementById("menpai1").value >= mp_limit)  // TODO 返回是float or string？
        {alert("TODO ");}
        else if (document.getElementById("menpai1").value <= 0)
        {alert("同归于尽[BAD END]TODO  凌虚阁的覆灭只在一夜之间。鉴于凌虚阁掌门不过一介元婴修士，许多人认为这是迟早的事。<br>郦自衡不在此列。他陈恳地问玲：“你是故意的，还是不小心？”");}
        else if (document.getElementById("menpai2").value >= mp_limit)
        {alert("TODO ");}
        else if (document.getElementById("menpai2").value <= 0)
        {alert("TODO ");}
        else if (document.getElementById("menpai3").value >= mp_limit)
        {alert("TODO ");}
        else if (document.getElementById("menpai3").value <= 0)
        {alert("TODO ");}
        else if (document.getElementById("menpai4").value >= mp_limit)
        {alert("TODO ");}
        else if (document.getElementById("menpai4").value <= 0)
        {alert("TODO ");}
        else if (document.getElementById("menpai5").value >= mp_limit)
        {alert("TODO ");}
        else if (document.getElementById("menpai5").value <= 0)
        {alert("TODO ");}
        else if (document.getElementById("invest").value >= 100)
        {alert("TODO 胜利文本");}
        else if(document.getElementById("carry").value >= 100)
        {alert("TODO 失败文本");}
        else
        {end = false}
        return end
    }
    // 完成一个事件
    function finish_eve() {
        effect_dev = effect_o - effect_e
        // 势力值变化  TODO 未干涉
        if (effect_dev > 0)
        {menpai_change(charac_our, charac_enemy);}
        else if (effect_dev < 0)
        {menpai_change(charac_enemy, charac_our);}
        // 李伏封铮状态变化
        if (event_now == 1 && charac_our[1] == 4 && effect_dev > 0)
        {fighting = false;}  // 站李伏且胜利
        // 调查和转移进度
        inv = document.getElementById("invest");  
        car = document.getElementById("carry");  
        if (effect_dev > 0 && charac_enemy[0]!=0)  // 加入且胜利
        {
            inv.value += 5;
            new_output = "己方胜利";
        }
        else if (effect_dev < 0 && charac_enemy[0]!=0)  // 加入且失败
        {
            new_output = "己方失败";
        }
        else if (effect_dev == 0 && charac_enemy[0]!=0)  // 加入且平局
        {
            new_output = "平局";
        }
        else  // 未加入
        {
            new_output = "未干涉事件";
        }
        if(event_now == 3 && ((charac_enemy[0] == 2 && effect_dev < 0)
             || (charac_our[1] == 2 && effect_dev > 0) || 
             (charac_enemy[0] != 2 && charac_our[1] != 2)))  // 郦成功  
        {
            mp1 = document.getElementById("menpai1")
            if (mp1.value > 100 - car.value)  // 吃空
            {
                mp1.value -= 100 - car.value
                car.value = 100;
            }
            else 
            {
                car.value += mp1.value*0.7;
                mp1.value -= mp1.value*0.7;
            }
        }
        // 输出文字
        update_output(new_output)
        // 检查胜负
        if (winorfail())
        {
            // 隐藏按钮，可查看内容
            document.getElementById("eventdone").style.display = 'none';
        }
        else
        {new_event();}  // 新事件
        hide_info()
    }

    
</script>

<!-- 网页主体 -->
</head>
<body>
    <h1>纵横捭阖修道界！</h1>
    <p style="font-size:18px;">游戏背景：</p>
    <p>TODO</p>
    <details>
        <summary>游戏规则</summary>
        <ul>
            <li>
                <div class="inline-block" style="font-size:16px;">玩家不断处理事件，推进游戏发展。在事件中，</div>
                <button style="zoom:110%;">加入</button>
                <div class="inline-block" style="font-size:16px;">[对抗势力]的某一方后，玩家可以不断使用[己方角色]</div>
                <button style="zoom:110%;">游说</button>
                <div class="inline-block" style="font-size:16px;">[可招募角色]，将其招募；与此同时，敌方也会产生行动。</div>
                <div class="inline-block" style="font-size:16px;">在时机合适或无法继续招募时，点击</div>
                <button style="zoom:110%;">完成事件</button>
                <div class="inline-block" style="font-size:16px;">，结算对抗势力双方的影响力。影响力高的一方在事件中获得胜利。涉事门派的势力值随之变化。</div>
            </li>
            <li>
                <div class="inline-block" style="font-size:16px;">影响力和门派势力值变化的大小主要取决于角色的修为境界。小心挑选同盟，因为他们可能攫取过多的好处，造成局势失衡。</div>
            </li>
            <li>
                <div class="inline-block" style="font-size:16px;">加入事件并获胜可以提升[玲的调查进度]。你也可以不介入事件，通过直接点击</div>
                <button style="zoom:110%;">完成事件</button>
                <div class="inline-block" style="font-size:16px;">跳过事件，任其自由发展。</div><br>
            </li>
            <li>
                <div class="inline-block" style="font-size:16px;">达成胜利结局的条件是[玲的调查进度]达到100%，并且[郦自衡的筹备进度]&lt;100%、且所有门派的势力值&gt;0%且&lt;100%。</div>
                <div class="inline-block" style="font-size:16px;">反之，郦自衡率先完成筹备或西岳局势失衡将导向失败结局。</div><br>  
            </li>
            <li>
                <div class="inline-block" style="font-size:16px;">修为顺序：出窍-化神-元婴-金丹-筑基</div>  
            </li>  
        </ul>
        <ol>
            <div class="inline-block" style="font-size:16px;color: #B22222;">注意：该网页无需联网，也没有保存功能。刷新页面会导致游戏进度清空。</div><br>
            <div class="inline-block" style="font-size:16px;">祝大家玩得开心！(～￣▽￣)～</div>
        </ol>
    </details>
    <details>
        <summary>其他信息</summary>
        <ol>
            <div class="inline-block" style="font-size:16px;">版本：0.1</div><br>
            <div class="inline-block" style="font-size:16px;">作者：有叶（微博</div>
            <a href="https://weibo.com/u/3075744707" target="_blank">@Gerainte</a>                
            <div class="inline-block" style="font-size:16px;">，遇bug可私信）</div><br>
            <div class="inline-block" style="font-size:16px;">原作：</div>
            <a href="https://www.jjwxc.net/onebook.php?novelid=8902406" target="_blank">《总之先和武痴道尊谈恋爱吧》</a>
            <div class="inline-block" style="font-size:16px;">（晋江）</div>
        </ol>
    </details>
    <hr/>
    <style>
        .inline-block {display: inline;}
        body{margin: 20px;}
        .char-name {
            font-size: 16px;
            margin-bottom: 5px;
        }
        .char-desc {
            font-size: 12px;  /* 小两号 */
            line-height: 1.2;
            /* max-width: 100px; */
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 10px;      /* 左右15像素留白 */
            text-align: left;     /* 左对齐 */
            position: relative;   /* 为行动点定位做准备 */
            min-height: 80px;     /* 保证最低高度 */
        }
        input[type="checkbox"]:disabled + label {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* 剩余行动点定位样式 */
        .action-point {
            align-self: center;
            margin-top: auto; /* 推到最下方 */
        }
    </style>

    <!-- 开局初始化 -->
    <div class="inline-block" style="font-size:18px;">准备好了？那就开始吧！  </div><button id="start" style="zoom:110%;">点击可重开一局</button>
    
    <!-- 门派势力值 -->
    <p style="font-size:18px;">门派势力值：</p>
    
    <table width="720" border="0">
        <tr>
            <td style="height:30px;width:100px;text-align:center;vertical-align:top;">
                <div class="inline-block" style="font-size:16px;">凌虚阁：</div>
                <progress value="0" max="100" id="menpai1" style="zoom:100%;"></progress>
            </td>
            <td style="width:20px;text-align:center;vertical-align:top;">
                <div class="inline-block" style="font-size:16px;">古柯宗：</div>
                <progress value="0" max="100" id="menpai2" style="zoom:100%;"></progress>
            </td>
            <td style="width:20px;text-align:center;vertical-align:top;">
                <div class="inline-block" style="font-size:16px;">归藏门：</div>
                <progress value="0" max="100" id="menpai3" style="zoom:100%;"></progress>
            </td>
        </tr>
        <tr>
            <td style="height:30px;width:100px;text-align:center;vertical-align:top;">
                <div class="inline-block" style="font-size:16px;">淮山：</div>
                <progress value="0" max="100" id="menpai4" style="zoom:100%;"></progress>
            </td>
            <td style="width:20px;text-align:center;vertical-align:top;">
                <div class="inline-block" style="font-size:16px;">东岳：</div>
                <progress value="0" max="100" id="menpai5" style="zoom:100%;"></progress><br><br>
            </td>
        </tr>
    </table>
    <!-- 事件情报 -->
    <div class="inline-block" style="font-size:20px;">当前事件：[</div>
    <div class="inline-block" style="font-size:20px;" id="eve_name">？</div>
    <div class="inline-block" style="font-size:20px;">]</div>
    <div class="inline-block" id="place", style="font-size:14px;"></div>
    <p id="eve_desc"></p>
    <div class="inline-block" style="font-size:18px;">冲突双方：</div>
    <div class="inline-block" id="side1charc" style="font-size:18px;"></div>
    <div class="inline-block" id="side1" style="font-size:18px;">？</div>
    <button id="joinside1" style="zoom:110%;">加入</button>
    <div class="inline-block" style="font-size:24px;"><b>⚔</b></div>
    <div class="inline-block" id="side2charc" style="font-size:18px;"></div>
    <div class="inline-block" id="side2" style="font-size:18px;"></div>
    <button id="joinside2" style="zoom:110%;">加入</button><br><br>
    <!-- 敌方信息 -->
    <div class="inline-block" style="font-size:18px;" id="ene_efftxt"></div>
    <div class="inline-block" style="font-size:18px;" id="ene_chatxt"></div>
    <table width="980" border="0" id="ene_table">
        <tr>
            <td id="tdenemy1">
                <p id="enemy1"></p>
                <div class="char-desc" id="enemy1_desc"></div>
            </td>
            <td id="tdenemy2">
                <p id="enemy2"></p>
                <div class="char-desc" id="enemy2_desc"></div>
            </td>
            <td id="tdenemy3">
                <p id="enemy3"></p>
                <div class="char-desc" id="enemy3_desc"></div>
            </td>
            <td id="tdenemy4">
                <p id="enemy4"></p>
                <div class="char-desc" id="enemy4_desc"></div>
            </td>
            <td id="tdenemy5">
                <p id="enemy5"></p>
                <div class="char-desc" id="enemy5_desc"></div>
            </td>
            <td id="tdenemy6">
                <p id="enemy6"></p>
                <div class="char-desc" id="enemy6_desc"></div>
            </td>
            <td id="tdenemy7">
                <p id="enemy7"></p>
                <div class="char-desc" id="enemy7_desc"></div>
            </td>
        </tr>
    </table>
    <div class="inline-block" id="br1"></div>
    <!-- 游说模块 -->
    <div class="inline-block" style="font-size:18px;" id="totalktxt"></div>
    <table width="700" border="0" id="totalk_table">
        <tr>
        <td id="tdctotalk1">
            <p></p>
            <input type="radio" name="charac_to" id="charac_to1" style="vertical-align:middle;zoom:150%;" >
            <label for="1" id="ctotalk1"> </label><br>
            <div class="char-desc" id="ctotalk1_desc"></div>
            <p id="totalkstat1"></p> 
        </td>
        <td id="tdctotalk2">
            <p></p>
            <input type="radio" name="charac_to" id="charac_to2" style="vertical-align:middle;zoom:150%;" >
            <label for="1" id="ctotalk2"> </label><br>
            <div class="char-desc" id="ctotalk2_desc"></div>
            <p id="totalkstat2"></p>
        </td>
        <td id="tdctotalk3">
            <p></p>
            <input type="radio" name="charac_to" id="charac_to3" style="vertical-align:middle;zoom:150%;" >
            <label for="1" id="ctotalk3"> </label><br>
            <div class="char-desc" id="ctotalk3_desc"></div>
            <p id="totalkstat3"></p>
        </td>
        <td id="tdctotalk4">
            <p></p>
            <input type="radio" name="charac_to" id="charac_to4" style="vertical-align:middle;zoom:150%;" >
            <label for="1" id="ctotalk4"> </label><br>
            <div class="char-desc" id="ctotalk4_desc"></div>
            <p id="totalkstat4"></p>
        </td>
        <td id="tdctotalk5">
            <p></p>
            <input type="radio" name="charac_to" id="charac_to5" style="vertical-align:middle;zoom:150%;" >
            <label for="1" id="ctotalk5"> </label><br>
            <div class="char-desc" id="ctotalk5_desc"></div>
            <p id="totalkstat5"></p>
        </td>
        </tr>
    </table>
    <div class="inline-block" id="br2"></div>
    <div class="inline-block" style="font-size:18px;" id="our_efftxt"></div>
    <div class="inline-block" style="font-size:18px;" id="our_chatxt"></div>
    <table width="980" border="0" id="our_table">
        <tr>
        <td id="tdcgo1">
            <p></p>
            <input type="radio" name="charac_go" id="charac_go1" style="vertical-align:middle;zoom:150%;" >
            <label for="1" id="cgo1"> </label><br>
            <div class="char-desc" id="cgo1_desc"></div>
            <div class="inline-block" class="action-point" id="cango1"></div>
        </td>
        <td id="tdcgo2">
            <p></p>
            <input type="radio" name="charac_go" id="charac_go2" style="vertical-align:middle;zoom:150%;" >
            <label for="2" id="cgo2"> </label><br>
            <div class="char-desc" id="cgo2_desc"></div>
            <div class="inline-block" class="action-point" id="cango2"></div>
        </td>
        <td id="tdcgo3">
            <p></p>
            <input type="radio" name="charac_go" id="charac_go3" style="vertical-align:middle;zoom:150%;" >
            <label for="3" id="cgo3"> </label><br>
            <div class="char-desc" id="cgo3_desc"></div>
            <div class="inline-block" class="action-point" id="cango3"></div>
        </td>
        <td id="tdcgo4">
            <p></p>
            <input type="radio" name="charac_go" id="charac_go4" style="vertical-align:middle;zoom:150%;" >
            <label for="4" id="cgo4"> </label><br>
            <div class="char-desc" id="cgo4_desc"></div>
            <div class="inline-block" class="action-point" id="cango4"></div>
        </td>
        <td id="tdcgo5">
            <p></p>
            <input type="radio" name="charac_go" id="charac_go5" style="vertical-align:middle;zoom:150%;" >
            <label for="5" id="cgo5"> </label><br>
            <div class="char-desc" id="cgo5_desc"></div>
            <div class="inline-block" class="action-point" id="cango5"></div>
        </td>
        <td id="tdcgo6">
            <p></p>
            <input type="radio" name="charac_go" id="charac_go6" style="vertical-align:middle;zoom:150%;" >
            <label for="6" id="cgo6"> </label><br>
            <div class="char-desc" id="cgo6_desc"></div>
            <div class="inline-block" class="action-point" id="cango6"></div>
        </td>
        <td id="tdcgo7">
            <p></p>
            <input type="radio" name="charac_go" id="charac_go7" style="vertical-align:middle;zoom:150%;" >
            <label for="7" id="cgo7"> </label><br>
            <div class="char-desc" id="cgo7_desc"></div>
            <div class="inline-block" class="action-point" id="cango7"></div>
        </td>
        </tr>
    </table>
    <div class="inline-block" id="br3"></div>
    <button id="talk" style="zoom:110%;">游说</button>
    <p>历史进展：</p>
    <div id="scrollin" style="width: 600px;height: 100px; overflow-y:scroll;">
        <p style="font-size:15px;" id=eventoutput></p>
    </div>
    <button id="eventdone" style="zoom:110%;">完成事件</button><br><br>
    <div class="inline-block" style="font-size:16px;">玲的调查进度：</div>
    <progress value="0" max="100" id="invest" style="zoom:150%;"></progress><br>
    <div class="inline-block" style="font-size:16px;">郦自衡的筹备进度：</div>
    <progress value="0" max="100" id="carry" style="zoom:150%;"></progress>


    <!-- 玩家操作反馈 -->
    <script>
        // 初始化
        begin_game();
        var b_start = document.getElementById("start");
        b_start.addEventListener("click", begin_game);
        // 加入势力
        var b_jside1 = document.getElementById("joinside1");
        b_jside1.addEventListener("click", join_side1);
        var b_jside2 = document.getElementById("joinside2");
        b_jside2.addEventListener("click", join_side2);
        // 游说操作
        var b_talk = document.getElementById("talk");
        b_talk.addEventListener("click", talk_info); 
        // 完成事件
        var b_eventdone = document.getElementById("eventdone");
        b_eventdone.addEventListener("click", finish_eve);
    </script>


    
    </body>
</html>
